#!/sbin/openrc-run
description="Loki (daemonized) Simple IOC And Yara Scanner (fork)"
extra_commands=""
extra_started_commands="update"

workdir=/opt/Loki-daemonized
pidfile=${workdir}/loki.pid
command=/usr/bin/env
command_args="python3 loki.py --listen-host localhost --listen-port 1337 -d -s 20000 --noindicator --csv --nolog --intense --force"

depend() {
	need net
	use dns logger netmount
}

start() {
	ebegin "Starting Loki daemon"
	cd $workdir
	source bin/activate
	$command $command_args &> /dev/null &
}

stop() {
	ebegin "Stopping Loki daemon"
	kill -TERM $(cat $pidfile)
}

restart() {
	stop
	start
}

update() {
	cd $workdir
	stop
	. bin/activate
	./loki-upgrader.py --sigsonly --nolog
	deactivate
	start
}
